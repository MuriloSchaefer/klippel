import{c as n,e as D,d as T,R as w}from"../vendor-a3d4e7ed.js";import{M as H,C as J,D as q}from"./Composer/components-e33c329c.js";import{A as c,c as z,r as K,d as Q,S as R,a as G,l as W,b as j,u as X,e as I,f as Z,g as oo,h as so,i as x,j as to,k as eo,m as ao}from"../kernel-4d57db79.js";import{u as io}from"./Composer/hooks-e7e1f8fd.js";const i="Composer",no="0.0.1",U=n(`[${i}:Compositions:${c.COMMAND}] Add material`),Uo=n(`[${i}:Compositions:${c.COMMAND}] Add material type`),co=n(`[${i}:Compositions:${c.COMMAND}] Change material`),y=n(`[${i}:Compositions:${c.COMMAND}] Select part`),E=n(`[${i}:Compositions:${c.COMMAND}] Unselect part`),S=n(`[${i}:Compositions:${c.COMMAND}] Add to budget`),ro=n(`[${i}:Compositions:${c.COMMAND}] Add Proxy`),mo=n(`[${i}:Compositions:${c.COMMAND}] Delete Proxy`);n(`[${i}:Compositions:${c.COMMAND}] Update Proxy`);const po=n(`[${i}:Compositions:${c.COMMAND}] Add Restriction`),go=n(`[${i}:Compositions:${c.COMMAND}] Delete Restriction`),lo=n(`[${i}:Compositions:${c.COMMAND}] Update Restriction`),O=n(`[${i}:Compositions:${c.COMMAND}] Open debug viewport`);n(`[${i}:Compositions:${c.COMMAND}] Create debug viewport`);const Co=n(`[${i}:Compositions:${c.EVENT}] Material added`);n(`[${i}:Compositions:${c.EVENT}] Material type added`);const ho=n(`[${i}:Compositions:${c.EVENT}] Part selected`),Mo=n(`[${i}:Compositions:${c.EVENT}] Part unselected`),uo=n(`[${i}:Compositions:${c.EVENT}] Material changed`),No=n(`[${i}:Compositions:${c.EVENT}] Proxy added`),fo=n(`[${i}:Compositions:${c.EVENT}] Proxy deleted`);n(`[${i}:Compositions:${c.EVENT}] Proxy updated`);const $o=n(`[${i}:Compositions:${c.EVENT}] Restriction added`),vo=n(`[${i}:Compositions:${c.EVENT}] Restriction deleted`),Io=n(`[${i}:Compositions:${c.EVENT}] Restriction updated`),Eo=n(`[${i}:Compositions:${c.EVENT}] Debug viewport opened`);n(`[${i}:Compositions:${c.EVENT}] Debug viewport closed`);const Po=n(`[${i}:Compositions:${c.EVENT}] Added to budget`),xo=n(`[${i}:Compositions:${c.COMMAND}] List compositions`),b=n(`[${i}:Compositions:${c.COMMAND}] Store compositions list`),k=n(`[${i}:Compositions:${c.COMMAND}] Create composition`),A=n(`[${i}:Compositions:${c.COMMAND}] Close composition`);n(`[${i}:Compositions:${c.COMMAND}] Parse SVG`);const L=n(`[${i}:Compositions:${c.COMMAND}] Fetch model `),_=n(`[${i}:Compositions:${c.COMMAND}] Store model`),B=n(`[${i}:Compositions:${c.COMMAND}] Load proxies`),yo=n(`[${i}:Compositions:${c.COMMAND}] Compositions listed`),So=n(`[${i}:Compositions:${c.COMMAND}] Stored compositions list`),Oo=n(`[${i}:Compositions:${c.EVENT}] Composition created`),bo=n(`[${i}:Compositions:${c.EVENT}] Composition closed`);n(`[${i}:Compositions:${c.EVENT}] SVG parsed`);const F=n(`[${i}:Compositions:${c.EVENT}] Model fetched`),Ao=n(`[${i}:Compositions:${c.EVENT}] Proxies loaded`),Y=n(`[${i}:Compositions:${c.EVENT}] Model stored`),ko=t=>t.Composer,u=D();u.startListening({actionCreator:xo,effect:async({payload:t},o)=>{const{dispatch:s}=o,e=[{name:"Camisa polo feminina",svgPath:"catalog/camisa-polo/decorated.svg",descriptionPath:"catalog/camisa-polo/description.md"},{name:"Camisa polo masculina",svgPath:"catalog/camisa-polo/decorated.svg",descriptionPath:"catalog/camisa-polo/description.md"},{name:"Camiseta baby look",svgPath:"catalog/camisa-polo/decorated.svg"},{name:"Camiseta gola v",svgPath:"catalog/camisa-polo/decorated.svg"},{name:"Camisa social",svgPath:"catalog/camisa-polo/decorated.svg"},{name:"Camisete social",svgPath:"catalog/camisa-polo/decorated.svg"},{name:"Camiseta gola v",svgPath:"catalog/camisa-polo/decorated.svg"},{name:"Camisa social",svgPath:"catalog/camisa-polo/decorated.svg"},{name:"Camisete social",svgPath:"catalog/camisa-polo/decorated.svg"},{name:"Camiseta gola v",svgPath:"catalog/camisa-polo/decorated.svg"},{name:"Camisa social",svgPath:"catalog/camisa-polo/decorated.svg"},{name:"Camisete social",svgPath:"catalog/camisa-polo/decorated.svg"},{name:"Camiseta gola v",svgPath:"catalog/camisa-polo/decorated.svg"},{name:"Camisa social",svgPath:"catalog/camisa-polo/decorated.svg"},{name:"Camisete social",svgPath:"catalog/camisa-polo/decorated.svg"},{name:"Camiseta gola v",svgPath:"catalog/camisa-polo/decorated.svg"},{name:"Camisa social",svgPath:"catalog/camisa-polo/decorated.svg"},{name:"Camisete social",svgPath:"catalog/camisa-polo/decorated.svg"}];s(b(e)),s(yo(e))}});u.startListening({actionCreator:b,effect:async({payload:t},o)=>{const{dispatch:s}=o;s(So(t))}});u.startListening({actionCreator:k,effect:async({payload:t},o)=>{const{dispatch:s,getState:e}=o,{Composer:{compositionsManager:a}}=e();s(Oo(a.compositions[t.name]))}});u.startListening({actionCreator:z,effect:async({payload:t},o)=>{const{dispatch:s,getState:e}=o,{Composer:{compositionsManager:a}}=e();Object.values(a.compositions).forEach(r=>{r.viewportName===t.name&&s(A({name:r.name,graphId:r.graphId})),r.debugViewport===t.name&&s(K({viewportName:r.name}))})}});u.startListening({actionCreator:A,effect:async({payload:t},o)=>{const{dispatch:s}=o;s(Q({graphId:t.graphId})),s(bo({name:t.name}))}});u.startListening({actionCreator:R,effect:async({payload:t},o)=>{const{dispatch:s,getState:e}=o,{Composer:{compositionsManager:a}}=e(),r=Object.values(a.compositions).filter(g=>g.svgPath===t.path);if(!t.content)return;const d=new DOMParser().parseFromString(t.content,"image/svg+xml").getElementsByTagName("modelPath").item(0)?.innerHTML;d&&r.forEach(g=>{g.loading.loadModel==="not-started"&&s(L({compositionName:g.name,modelPath:d}))})}});u.startListening({actionCreator:L,effect:async({payload:t},o)=>{const{dispatch:s,getState:e}=o,{Composer:{compositionsManager:a}}=e(),r=a.compositions[t.compositionName],m=await(await(await fetch(t.modelPath)).blob()).text();s(F({compositionName:r.name,model:JSON.parse(m)}))}});u.startListening({actionCreator:F,effect:async({payload:t},o)=>{const{dispatch:s,getState:e}=o,{Composer:{compositionsManager:a}}=e(),r=a.compositions[t.compositionName];s(B({compositionName:r.name,model:t.model})),s(_({compositionName:r.name,model:t.model}))}});u.startListening({actionCreator:B,effect:async({payload:t},o)=>{const{dispatch:s,getState:e}=o,{Composer:{compositionsManager:a},Materials:{materials:r}}=e(),p=a.compositions[t.compositionName],m=t.model.nodes;Object.values(m).forEach(d=>{if(!("proxies"in d))return;const g=m[d.materialId];g||console.warn(`Missing material node ${d.materialId}! parsing material id`);const l=g?.materialId??d.materialId.split("-")[1],M=r[l],h=d.proxies.reduce((f,C)=>({...f,[C.elem]:{...f[C.elem],[C.attr]:M.attributes.cor.hex}}),{});Object.entries(h).forEach(([f,C])=>{s(G({path:p.svgPath,instanceName:p.name,id:f,styles:C}))})}),s(Ao({compositionName:p.name,model:t.model}))}});u.startListening({actionCreator:_,effect:async({payload:t},o)=>{const{dispatch:s,getState:e}=o,{Composer:{compositionsManager:a}}=e(),r=a.compositions[t.compositionName];s(W({graphId:r.graphId,graph:t.model})),s(Y({compositionName:r.name,model:t.model}))}});u.startListening({actionCreator:O,effect:async({payload:t},o)=>{const{dispatch:s,getState:e}=o,{Composer:{compositionsManager:a}}=e();a.compositions[t.compositionName],s(Eo({compositionName:t.compositionName,viewportName:t.debugViewport}))}});const N=D();N.startListening({actionCreator:U,effect:async({payload:t},o)=>{const{dispatch:s,getState:e}=o,{Composer:{compositionsManager:a},Materials:{materials:r,materialTypes:p}}=e(),m=r[t.materialId],d=p[m.type],g=d.schemas[d.latestSchema],l=a.compositions[t.compositionName].graphId,M=`material-${t.materialId}`,h={id:M,type:"MATERIAL",label:m.attributes[g.selector.principal],materialId:t.materialId,position:{x:0,y:0}};s(j({graphId:l,node:h,edges:{inputs:{},outputs:{}}})),s(Co({compositionName:t.compositionName,materialId:t.materialId,nodeId:M}))}});N.startListening({actionCreator:co,effect:async({payload:{compositionName:t,materialUsageId:o,materialId:s}},e)=>{const{dispatch:a,getState:r}=e,p=r(),m=p.Composer.compositionsManager.compositions[t],d=p.Graph.graphs[m.graphId],g=p.Materials.materials[s],l=`material-${s}`;l in d.nodes||a(U({compositionName:m.name,materialId:s}));const h=d.nodes[o],f=Object.values(d.edges).filter(C=>C.sourceId===o&&C.type=="CONSUMES");if("proxies"in h&&h.proxies.length>0&&"cor"in g.attributes){const C=h.proxies.reduce(($,{attr:P,elem:V})=>({...$,[V]:{...$[V],[P]:g.attributes.cor.hex}}),{});Object.entries(C).forEach(([$,P])=>{a(X({path:m.svgPath,instanceName:m.name,id:$,changes:P}))})}a(I({graphId:m.graphId,nodeId:o,changes:{materialId:l}})),a(Z({edge:{id:`${o}->${l}`,sourceId:o,targetId:l,type:"CONSUMES"},graphId:m.graphId})),f.forEach(C=>{a(oo({graphId:m.graphId,edgeId:C.id}))}),a(uo({compositionName:t,materialUsageId:o,materialId:l}))}});N.startListening({actionCreator:y,effect:async({payload:t},o)=>{const{dispatch:s}=o;s(ho(t))}});N.startListening({actionCreator:so,effect:async({payload:t},o)=>{const{dispatch:s,getState:e}=o,{Composer:{compositionsManager:{compositions:a}}}=e(),r=Object.values(a).find(p=>p.viewportName===t.viewportName);r&&s(E({compositionName:r.name}))}});N.startListening({actionCreator:E,effect:async({payload:t},o)=>{const{dispatch:s}=o;s(Mo({compositionName:t.compositionName}))}});N.startListening({actionCreator:po,effect:async({payload:{compositionName:t,materialId:o,restriction:s}},e)=>{const{dispatch:a,getState:r}=e,{Composer:{compositionsManager:{compositions:p}},Graph:{graphs:m}}=r(),d=p[t],{searchResults:g}=m[d.graphId];a(j({graphId:d.graphId,node:s,edges:{inputs:{[o]:{id:`${o}->${s.id}`,type:"RESTRICTED_BY",attr:s.attribute,sourceId:o,targetId:s.id}},outputs:{}}})),Object.entries(g).filter(([l,M])=>!!l.includes("restriction")).forEach(([l,M])=>a(x({graphId:d.graphId,searchId:l}))),a($o({compositionName:t,materialId:o,restrictionId:s.id}))}});N.startListening({actionCreator:lo,effect:async({payload:{compositionName:t,materialId:o,restrictionId:s,changes:e}},a)=>{const{dispatch:r,getState:p}=a,{Composer:{compositionsManager:{compositions:m}},Graph:{graphs:d}}=p(),g=m[t],{searchResults:l}=d[g.graphId];r(I({graphId:g.graphId,nodeId:s,changes:e})),Object.entries(l).filter(([M,h])=>!!h.findings.find(f=>f.id===s)).forEach(([M,h])=>r(x({graphId:g.graphId,searchId:M}))),r(Io({compositionName:t,materialId:o,restrictionId:s}))}});N.startListening({actionCreator:go,effect:async({payload:t},o)=>{const{dispatch:s,getState:e}=o,{Composer:{compositionsManager:{compositions:a}},Graph:{graphs:r}}=e(),p=a[t.compositionName],{searchResults:m}=r[p.graphId];s(to({graphId:p.graphId,nodeId:t.restrictionId})),Object.entries(m).filter(([d,g])=>!!g.findings.find(l=>l.id===t.restrictionId)).forEach(([d,g])=>s(x({graphId:p.graphId,searchId:d}))),s(vo(t))}});N.startListening({actionCreator:mo,effect:async({payload:t},o)=>{const{dispatch:s,getState:e}=o,{Composer:{compositionsManager:{compositions:a}},Graph:{graphs:r}}=e(),p=a[t.compositionName],m=r[p.graphId];if(!p.selectedPart){console.warn("trying to delete proxy without selecting a part");return}const d=m.nodes[t.materialId];if(!("proxies"in d))return;const g=d.proxies.filter(l=>l.elem!==t.proxyId);s(I({graphId:p.graphId,nodeId:t.materialId,changes:{proxies:g}})),s(eo({path:p.svgPath,instanceName:p.name,id:t.proxyId})),s(fo(t))}});N.startListening({actionCreator:ro,effect:async({payload:t},o)=>{const{dispatch:s,getState:e}=o,{Composer:{compositionsManager:{compositions:a}},Graph:{graphs:r},Materials:{materials:p}}=e(),m=a[t.compositionName],d=r[m.graphId];if(!m.selectedPart){console.error("trying to delete proxy without selecting a part");return}const g=d.nodes[t.materialId];if(!("proxies"in g)){console.error("trying to add proxy in an node that does not support proxies");return}const l=[...g.proxies,t.proxy],M=Number(g.materialId.split("-")[1]),h=p[M];if(!("cor"in h.attributes)){console.error("material does not have a color attribute ");return}const f=l.filter(C=>C.elem===t.proxy.elem).reduce((C,$)=>({...C,[$.attr]:h.attributes.cor.hex}),{});s(I({graphId:m.graphId,nodeId:t.materialId,changes:{proxies:l}})),s(G({path:m.svgPath,instanceName:m.name,id:t.proxy.elem,styles:f})),s(No(t))}});N.startListening({actionCreator:S,effect:async({payload:t},o)=>{const{dispatch:s}=o;s(Po({budgetId:t.budgetId,compositionName:t.compositionName}))}});const Lo={loading:{loadSVG:"not-started",loadModel:"not-started"},budget:void 0},Vo={compositionsManager:{compositions:{},compositionsList:[]}},v=T({name:i,initialState:{},reducers:{},extraReducers:t=>{t.addCase(y,(o,{payload:{partName:s}})=>({...o,selectedPart:s})),t.addCase(S,(o,{payload:{budgetId:s,gradesInfo:e}})=>({...o,budget:{budgetId:s,grades:e.reduce((a,r)=>({...a,[r]:0}),{})}})),t.addCase(E,o=>({...o,selectedPart:void 0})),t.addCase(O,(o,{payload:s})=>({...o,debugViewport:s.debugViewport}))}}),wo=T({name:i,initialState:Vo,reducers:{},extraReducers:t=>{t.addCase(k,(o,{payload:{name:s,viewportName:e,svgPath:a,graphId:r}})=>({...o,compositionsManager:{...o.compositionsManager,compositions:{...o.compositionsManager.compositions,[s]:{...Lo,name:s,svgPath:a,graphId:r,viewportName:e}}}})).addCase(b,(o,s)=>({...o,compositionsManager:{...o.compositionsManager,compositionsList:s.payload}})).addCase(A,(o,{payload:{name:s}})=>({...o,compositionsManager:{...o.compositionsManager,compositions:Object.values(o.compositionsManager.compositions).reduce((e,a)=>a.name===s?e:{...e,[a.name]:a},{})}})).addCase(ao,(o,{payload:{path:s}})=>{const e=Object.values(o.compositionsManager.compositions).find(a=>a.svgPath===s);return e?{...o,compositionsManager:{...o.compositionsManager,compositions:{...o.compositionsManager.compositions,[e.name]:{...e,loading:{...e.loading,loadSVG:"started"}}}}}:o}),t.addCase(R,(o,{payload:{path:s}})=>{const e=Object.values(o.compositionsManager.compositions).find(a=>a.svgPath===s);return e?{...o,compositionsManager:{...o.compositionsManager,compositions:{...o.compositionsManager.compositions,[e.name]:{...e,loading:{...e.loading,loadSVG:"completed"}}}}}:o}),t.addCase(L,(o,{payload:{compositionName:s}})=>({...o,compositionsManager:{...o.compositionsManager,compositions:{...o.compositionsManager.compositions,[s]:{...o.compositionsManager.compositions[s],loading:{...o.compositionsManager.compositions[s].loading,loadModel:"started"}}}}})),t.addCase(Y,(o,{payload:s})=>({...o,compositionsManager:{...o.compositionsManager,compositions:{...o.compositionsManager.compositions,[s.compositionName]:{...o.compositionsManager.compositions[s.compositionName],loading:{...o.compositionsManager.compositions[s.compositionName].loading,loadModel:"completed"}}}}})),t.addCase(y,(o,s)=>({...o,compositionsManager:{...o.compositionsManager,compositions:{...o.compositionsManager.compositions,[s.payload.compositionName]:v.reducer(o.compositionsManager.compositions[s.payload.compositionName],s)}}})),t.addCase(E,(o,s)=>({...o,compositionsManager:{...o.compositionsManager,compositions:{...o.compositionsManager.compositions,[s.payload.compositionName]:v.reducer(o.compositionsManager.compositions[s.payload.compositionName],s)}}})),t.addCase(O,(o,s)=>({...o,compositionsManager:{...o.compositionsManager,compositions:{...o.compositionsManager.compositions,[s.payload.compositionName]:v.reducer(o.compositionsManager.compositions[s.payload.compositionName],s)}}})),t.addCase(S,(o,s)=>({...o,compositionsManager:{...o.compositionsManager,compositions:{...o.compositionsManager.compositions,[s.payload.compositionName]:v.reducer(o.compositionsManager.compositions[s.payload.compositionName],s)}}}))}});function Do({managers:{storeManager:t,componentRegistryManager:o,layoutManager:s,ribbonMenuManager:e,viewportManager:a}}){t.functions.loadReducer(i,wo.reducer),t.functions.registerMiddleware(u),t.functions.registerMiddleware(N),o.functions.registerComponents({ribbonMenuSections:{ModelSelector:w.memo(H)},viewportTypes:{Composer:w.memo(J),DebuggerViewport:q}}),e.functions.addNewTab({label:"Compositor",sectionNames:["ModelSelector"],type:"base"})}const _o={name:i,version:no,depends_on:["Layout","Graph","SVG","Materials","Converter"],components:{},hooks:{useComposition:io},kernelCalls:{startModule:Do,restartModule(){},shutdownModule(){}}};export{S as a,po as b,Uo as c,go as d,co as e,ro as f,mo as g,ko as h,k as i,xo as l,_o as m,O as o,y as s,lo as u};
