import{c as n,e as A,d as D,R as w}from"../vendor-8eb1de95.js";import{M as Y,C as H,D as J}from"./Composer/components-d2e3c058.js";import{A as c,c as q,r as z,d as K,S as T,a as R,l as Q,b as G,u as W,e as v,f as X,g as Z,h as oo,i as x,j as so,k as to,m as eo}from"../kernel-a935b9dd.js";const i="Composer",ao="0.0.1",j=n(`[${i}:Compositions:${c.COMMAND}] Add material`),To=n(`[${i}:Compositions:${c.COMMAND}] Add material type`),io=n(`[${i}:Compositions:${c.COMMAND}] Change material`),S=n(`[${i}:Compositions:${c.COMMAND}] Select part`),E=n(`[${i}:Compositions:${c.COMMAND}] Unselect part`),no=n(`[${i}:Compositions:${c.COMMAND}] Add Proxy`),co=n(`[${i}:Compositions:${c.COMMAND}] Delete Proxy`);n(`[${i}:Compositions:${c.COMMAND}] Update Proxy`);const ro=n(`[${i}:Compositions:${c.COMMAND}] Add Restriction`),mo=n(`[${i}:Compositions:${c.COMMAND}] Delete Restriction`),po=n(`[${i}:Compositions:${c.COMMAND}] Update Restriction`),y=n(`[${i}:Compositions:${c.COMMAND}] Open debug viewport`);n(`[${i}:Compositions:${c.COMMAND}] Create debug viewport`);const go=n(`[${i}:Compositions:${c.EVENT}] Material added`);n(`[${i}:Compositions:${c.EVENT}] Material type added`);const lo=n(`[${i}:Compositions:${c.EVENT}] Part selected`),Co=n(`[${i}:Compositions:${c.EVENT}] Part unselected`),ho=n(`[${i}:Compositions:${c.EVENT}] Material changed`),Mo=n(`[${i}:Compositions:${c.EVENT}] Proxy added`),uo=n(`[${i}:Compositions:${c.EVENT}] Proxy deleted`);n(`[${i}:Compositions:${c.EVENT}] Proxy updated`);const fo=n(`[${i}:Compositions:${c.EVENT}] Restriction added`),No=n(`[${i}:Compositions:${c.EVENT}] Restriction deleted`),$o=n(`[${i}:Compositions:${c.EVENT}] Restriction updated`),vo=n(`[${i}:Compositions:${c.EVENT}] Debug viewport opened`);n(`[${i}:Compositions:${c.EVENT}] Debug viewport closed`);const Eo=n(`[${i}:Compositions:${c.COMMAND}] List compositions`),O=n(`[${i}:Compositions:${c.COMMAND}] Store compositions list`),U=n(`[${i}:Compositions:${c.COMMAND}] Create composition`),L=n(`[${i}:Compositions:${c.COMMAND}] Close composition`);n(`[${i}:Compositions:${c.COMMAND}] Parse SVG`);const V=n(`[${i}:Compositions:${c.COMMAND}] Fetch model `),_=n(`[${i}:Compositions:${c.COMMAND}] Store model`),k=n(`[${i}:Compositions:${c.COMMAND}] Load proxies`),Io=n(`[${i}:Compositions:${c.COMMAND}] Compositions listed`),Po=n(`[${i}:Compositions:${c.COMMAND}] Stored compositions list`),xo=n(`[${i}:Compositions:${c.EVENT}] Composition created`),So=n(`[${i}:Compositions:${c.EVENT}] Composition closed`);n(`[${i}:Compositions:${c.EVENT}] SVG parsed`);const F=n(`[${i}:Compositions:${c.EVENT}] Model fetched`),yo=n(`[${i}:Compositions:${c.EVENT}] Proxies loaded`),B=n(`[${i}:Compositions:${c.EVENT}] Model stored`),Ro=t=>t.Composer,C=A();C.startListening({actionCreator:Eo,effect:async({payload:t},o)=>{const{dispatch:s}=o,e=[{name:"Camisa polo feminina",svgPath:"catalog/camisa-polo/decorated.svg",descriptionPath:"catalog/camisa-polo/description.md"},{name:"Camisa polo masculina",svgPath:"catalog/camisa-polo/decorated.svg",descriptionPath:"catalog/camisa-polo/description.md"},{name:"Camiseta baby look",svgPath:"catalog/camisa-polo/decorated.svg"},{name:"Camiseta gola v",svgPath:"catalog/camisa-polo/decorated.svg"},{name:"Camisa social",svgPath:"catalog/camisa-polo/decorated.svg"},{name:"Camisete social",svgPath:"catalog/camisa-polo/decorated.svg"},{name:"Camiseta gola v",svgPath:"catalog/camisa-polo/decorated.svg"},{name:"Camisa social",svgPath:"catalog/camisa-polo/decorated.svg"},{name:"Camisete social",svgPath:"catalog/camisa-polo/decorated.svg"},{name:"Camiseta gola v",svgPath:"catalog/camisa-polo/decorated.svg"},{name:"Camisa social",svgPath:"catalog/camisa-polo/decorated.svg"},{name:"Camisete social",svgPath:"catalog/camisa-polo/decorated.svg"},{name:"Camiseta gola v",svgPath:"catalog/camisa-polo/decorated.svg"},{name:"Camisa social",svgPath:"catalog/camisa-polo/decorated.svg"},{name:"Camisete social",svgPath:"catalog/camisa-polo/decorated.svg"},{name:"Camiseta gola v",svgPath:"catalog/camisa-polo/decorated.svg"},{name:"Camisa social",svgPath:"catalog/camisa-polo/decorated.svg"},{name:"Camisete social",svgPath:"catalog/camisa-polo/decorated.svg"}];s(O(e)),s(Io(e))}});C.startListening({actionCreator:O,effect:async({payload:t},o)=>{const{dispatch:s}=o;s(Po(t))}});C.startListening({actionCreator:U,effect:async({payload:t},o)=>{const{dispatch:s,getState:e}=o,{Composer:{compositionsManager:a}}=e();s(xo(a.compositions[t.name]))}});C.startListening({actionCreator:q,effect:async({payload:t},o)=>{const{dispatch:s,getState:e}=o,{Composer:{compositionsManager:a}}=e();Object.values(a.compositions).forEach(r=>{r.viewportName===t.name&&s(L({name:r.name,graphId:r.graphId})),r.debugViewport===t.name&&s(z({viewportName:r.name}))})}});C.startListening({actionCreator:L,effect:async({payload:t},o)=>{const{dispatch:s}=o;s(K({graphId:t.graphId})),s(So({name:t.name}))}});C.startListening({actionCreator:T,effect:async({payload:t},o)=>{const{dispatch:s,getState:e}=o,{Composer:{compositionsManager:a}}=e(),r=Object.values(a.compositions).filter(p=>p.svgPath===t.path);if(!t.content)return;const l=new DOMParser().parseFromString(t.content,"image/svg+xml").getElementsByTagName("modelPath").item(0)?.innerHTML;l&&r.forEach(p=>{p.loading.loadModel==="not-started"&&s(V({compositionName:p.name,modelPath:l}))})}});C.startListening({actionCreator:V,effect:async({payload:t},o)=>{const{dispatch:s,getState:e}=o,{Composer:{compositionsManager:a}}=e(),r=a.compositions[t.compositionName],m=await(await(await fetch(t.modelPath)).blob()).text();s(F({compositionName:r.name,model:JSON.parse(m)}))}});C.startListening({actionCreator:F,effect:async({payload:t},o)=>{const{dispatch:s,getState:e}=o,{Composer:{compositionsManager:a}}=e(),r=a.compositions[t.compositionName];s(k({compositionName:r.name,model:t.model})),s(_({compositionName:r.name,model:t.model}))}});C.startListening({actionCreator:k,effect:async({payload:t},o)=>{const{dispatch:s,getState:e}=o,{Composer:{compositionsManager:a}}=e(),r=a.compositions[t.compositionName],d=t.model.nodes;Object.values(d).forEach(m=>{if(!("proxies"in m))return;const l=m.proxies.reduce((p,g)=>({...p,[g.elem]:{...p[g.elem],[g.attr]:"grey"}}),{});Object.entries(l).forEach(([p,g])=>{s(R({path:r.svgPath,instanceName:r.name,id:p,styles:g}))})}),s(yo({compositionName:r.name,model:t.model}))}});C.startListening({actionCreator:_,effect:async({payload:t},o)=>{const{dispatch:s,getState:e}=o,{Composer:{compositionsManager:a}}=e(),r=a.compositions[t.compositionName];s(Q({graphId:r.graphId,graph:t.model})),s(B({compositionName:r.name,model:t.model}))}});C.startListening({actionCreator:y,effect:async({payload:t},o)=>{const{dispatch:s,getState:e}=o,{Composer:{compositionsManager:a}}=e();a.compositions[t.compositionName],s(vo({compositionName:t.compositionName,viewportName:t.debugViewport}))}});const M=A();M.startListening({actionCreator:j,effect:async({payload:t},o)=>{const{dispatch:s,getState:e}=o,{Composer:{compositionsManager:a},Materials:{materials:r,materialTypes:d}}=e(),m=r[t.materialId],l=d[m.type],p=l.schemas[l.latestSchema],g=a.compositions[t.compositionName].graphId,u=`material-${t.materialId}`,h={id:u,type:"MATERIAL",label:m.attributes[p.selector.principal],materialId:t.materialId,position:{x:0,y:0}};s(G({graphId:g,node:h,edges:{inputs:{},outputs:{}}})),s(go({compositionName:t.compositionName,materialId:t.materialId,nodeId:u}))}});M.startListening({actionCreator:io,effect:async({payload:{compositionName:t,materialUsageId:o,materialId:s}},e)=>{const{dispatch:a,getState:r}=e,d=r(),m=d.Composer.compositionsManager.compositions[t],l=d.Graph.graphs[m.graphId],p=d.Materials.materials[s],g=`material-${s}`;g in l.nodes||a(j({compositionName:m.name,materialId:s}));const h=l.nodes[o],$=Object.values(l.edges).filter(f=>f.sourceId===o&&f.type=="CONSUMES");if("proxies"in h&&h.proxies.length>0&&"cor"in p.attributes){const f=h.proxies.reduce((N,{attr:I,elem:b})=>({...N,[b]:{...N[b],[I]:p.attributes.cor.hex}}),{});Object.entries(f).forEach(([N,I])=>{a(W({path:m.svgPath,instanceName:m.name,id:N,changes:I}))})}a(v({graphId:m.graphId,nodeId:o,changes:{materialId:g}})),a(X({edge:{id:`${o}->${g}`,sourceId:o,targetId:g,type:"CONSUMES"},graphId:m.graphId})),$.forEach(f=>{a(Z({graphId:m.graphId,edgeId:f.id}))}),a(ho({compositionName:t,materialUsageId:o,materialId:g}))}});M.startListening({actionCreator:S,effect:async({payload:t},o)=>{const{dispatch:s}=o;s(lo(t))}});M.startListening({actionCreator:oo,effect:async({payload:t},o)=>{const{dispatch:s,getState:e}=o,{Composer:{compositionsManager:{compositions:a}}}=e(),r=Object.values(a).find(d=>d.viewportName===t.viewportName);r&&s(E({compositionName:r.name}))}});M.startListening({actionCreator:E,effect:async({payload:t},o)=>{const{dispatch:s}=o;s(Co({compositionName:t.compositionName}))}});M.startListening({actionCreator:ro,effect:async({payload:{compositionName:t,materialId:o,restriction:s}},e)=>{const{dispatch:a,getState:r}=e,{Composer:{compositionsManager:{compositions:d}},Graph:{graphs:m}}=r(),l=d[t],{searchResults:p}=m[l.graphId];a(G({graphId:l.graphId,node:s,edges:{inputs:{[o]:{id:`${o}->${s.id}`,type:"RESTRICTED_BY",attr:s.attribute,sourceId:o,targetId:s.id}},outputs:{}}})),Object.entries(p).filter(([g,u])=>!!g.includes("restriction")).forEach(([g,u])=>a(x({graphId:l.graphId,searchId:g}))),a(fo({compositionName:t,materialId:o,restrictionId:s.id}))}});M.startListening({actionCreator:po,effect:async({payload:{compositionName:t,materialId:o,restrictionId:s,changes:e}},a)=>{const{dispatch:r,getState:d}=a,{Composer:{compositionsManager:{compositions:m}},Graph:{graphs:l}}=d(),p=m[t],{searchResults:g}=l[p.graphId];r(v({graphId:p.graphId,nodeId:s,changes:e})),Object.entries(g).filter(([u,h])=>!!h.findings.find($=>$.id===s)).forEach(([u,h])=>r(x({graphId:p.graphId,searchId:u}))),r($o({compositionName:t,materialId:o,restrictionId:s}))}});M.startListening({actionCreator:mo,effect:async({payload:t},o)=>{const{dispatch:s,getState:e}=o,{Composer:{compositionsManager:{compositions:a}},Graph:{graphs:r}}=e(),d=a[t.compositionName],{searchResults:m}=r[d.graphId];s(so({graphId:d.graphId,nodeId:t.restrictionId})),Object.entries(m).filter(([l,p])=>!!p.findings.find(g=>g.id===t.restrictionId)).forEach(([l,p])=>s(x({graphId:d.graphId,searchId:l}))),s(No(t))}});M.startListening({actionCreator:co,effect:async({payload:t},o)=>{const{dispatch:s,getState:e}=o,{Composer:{compositionsManager:{compositions:a}},Graph:{graphs:r}}=e(),d=a[t.compositionName],m=r[d.graphId];if(!d.selectedPart){console.warn("trying to delete proxy without selecting a part");return}const l=m.nodes[t.materialId];if(!("proxies"in l))return;const p=l.proxies.filter(g=>g.elem!==t.proxyId);s(v({graphId:d.graphId,nodeId:t.materialId,changes:{proxies:p}})),s(to({path:d.svgPath,instanceName:d.name,id:t.proxyId})),s(uo(t))}});M.startListening({actionCreator:no,effect:async({payload:t},o)=>{const{dispatch:s,getState:e}=o,{Composer:{compositionsManager:{compositions:a}},Graph:{graphs:r},Materials:{materials:d}}=e(),m=a[t.compositionName],l=r[m.graphId];if(!m.selectedPart){console.error("trying to delete proxy without selecting a part");return}const p=l.nodes[t.materialId];if(!("proxies"in p)){console.error("trying to add proxy in an node that does not support proxies");return}const g=[...p.proxies,t.proxy],u=Number(p.materialId.split("-")[1]),h=d[u];if(!("cor"in h.attributes)){console.error("material does not have a color attribute ");return}const $=g.filter(f=>f.elem===t.proxy.elem).reduce((f,N)=>({...f,[N.attr]:h.attributes.cor.hex}),{});s(v({graphId:m.graphId,nodeId:t.materialId,changes:{proxies:g}})),s(R({path:m.svgPath,instanceName:m.name,id:t.proxy.elem,styles:$})),s(Mo(t))}});const Oo={loading:{loadSVG:"not-started",loadModel:"not-started"}},Lo={compositionsManager:{compositions:{},compositionsList:[]}},P=D({name:i,initialState:{},reducers:{},extraReducers:t=>{t.addCase(S,(o,{payload:{partName:s}})=>({...o,selectedPart:s})),t.addCase(E,o=>({...o,selectedPart:void 0})),t.addCase(y,(o,{payload:s})=>({...o,debugViewport:s.debugViewport}))}}),Vo=D({name:i,initialState:Lo,reducers:{},extraReducers:t=>{t.addCase(U,(o,{payload:{name:s,viewportName:e,svgPath:a,graphId:r}})=>({...o,compositionsManager:{...o.compositionsManager,compositions:{...o.compositionsManager.compositions,[s]:{...Oo,name:s,svgPath:a,graphId:r,viewportName:e}}}})).addCase(O,(o,s)=>({...o,compositionsManager:{...o.compositionsManager,compositionsList:s.payload}})).addCase(L,(o,{payload:{name:s}})=>({...o,compositionsManager:{...o.compositionsManager,compositions:Object.values(o.compositionsManager.compositions).reduce((e,a)=>a.name===s?e:{...e,[a.name]:a},{})}})).addCase(eo,(o,{payload:{path:s}})=>{const e=Object.values(o.compositionsManager.compositions).find(a=>a.svgPath===s);return e?{...o,compositionsManager:{...o.compositionsManager,compositions:{...o.compositionsManager.compositions,[e.name]:{...e,loading:{...e.loading,loadSVG:"started"}}}}}:o}),t.addCase(T,(o,{payload:{path:s}})=>{const e=Object.values(o.compositionsManager.compositions).find(a=>a.svgPath===s);return e?{...o,compositionsManager:{...o.compositionsManager,compositions:{...o.compositionsManager.compositions,[e.name]:{...e,loading:{...e.loading,loadSVG:"completed"}}}}}:o}),t.addCase(V,(o,{payload:{compositionName:s}})=>({...o,compositionsManager:{...o.compositionsManager,compositions:{...o.compositionsManager.compositions,[s]:{...o.compositionsManager.compositions[s],loading:{...o.compositionsManager.compositions[s].loading,loadModel:"started"}}}}})),t.addCase(B,(o,{payload:s})=>({...o,compositionsManager:{...o.compositionsManager,compositions:{...o.compositionsManager.compositions,[s.compositionName]:{...o.compositionsManager.compositions[s.compositionName],loading:{...o.compositionsManager.compositions[s.compositionName].loading,loadModel:"completed"}}}}})),t.addCase(S,(o,s)=>({...o,compositionsManager:{...o.compositionsManager,compositions:{...o.compositionsManager.compositions,[s.payload.compositionName]:P.reducer(o.compositionsManager.compositions[s.payload.compositionName],s)}}})),t.addCase(E,(o,s)=>({...o,compositionsManager:{...o.compositionsManager,compositions:{...o.compositionsManager.compositions,[s.payload.compositionName]:P.reducer(o.compositionsManager.compositions[s.payload.compositionName],s)}}})),t.addCase(y,(o,s)=>({...o,compositionsManager:{...o.compositionsManager,compositions:{...o.compositionsManager.compositions,[s.payload.compositionName]:P.reducer(o.compositionsManager.compositions[s.payload.compositionName],s)}}}))}});function bo({managers:{storeManager:t,componentRegistryManager:o,layoutManager:s,ribbonMenuManager:e,viewportManager:a}}){t.functions.loadReducer(i,Vo.reducer),t.functions.registerMiddleware(C),t.functions.registerMiddleware(M),o.functions.registerComponents({ribbonMenuSections:{ModelSelector:w.memo(Y)},viewportTypes:{Composer:w.memo(H),DebuggerViewport:J}}),e.functions.addNewTab({label:"Compositor",sectionNames:["ModelSelector"],type:"base"})}const Go={name:i,version:ao,depends_on:["Layout","Graph","SVG","Materials","Converter"],components:{},kernelCalls:{startModule:bo,restartModule(){},shutdownModule(){}}};export{ro as a,To as b,io as c,mo as d,no as e,co as f,Ro as g,U as h,Eo as l,Go as m,y as o,S as s,po as u};
