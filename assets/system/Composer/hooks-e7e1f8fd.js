import{b as T,_ as R,r as $}from"../../vendor-a3d4e7ed.js";import{n as p}from"../../kernel-4d57db79.js";import{a as x,b as j,u as V,d as L,s as _,c as k,e as U,f as q,g as B,h as H,l as F,i as Y,o as z}from"../Composer-acd38dc0.js";const X=(f,M)=>{const h=p("Store"),E=p("Layout"),y=p("Graph"),v=p("Materials"),{useAppDispatch:N,useAppSelector:u}=h.hooks,i=N(),b=E.hooks.usePanelsManager(),{useGraph:S}=y.hooks,{useMaterials:l}=v.hooks,g=e=>{if(!e)return;const{compositionName:o,viewportName:t}=f;if(o)return e.Composer.compositionsManager.compositions[o];if(t)return Object.values(e.Composer.compositionsManager.compositions).find(a=>a.viewportName===t);console.warn("either compositionName or viewportName shall be provided")},r=T(g,M),m=u(r),c=u(g),s=S(c?.graphId,e=>({adjacencyList:e?.adjacencyList,nodes:e?.nodes,edges:e?.edges})),w=l();return{state:m,actions:{changeProperties(e,o){const t=s.state?.nodes?.garment;if(!t)throw Error("root node not found");const a={...t,label:e,description:o};s.actions.updateNode(a)},addToBudget(e,o){const t=Object.values(s.state?.nodes??{}).filter(a=>a.type==="GRADE").map(a=>a.id);i(x({compositionName:e,budgetId:o,gradesInfo:t}))},addGrade(e,o){const t=R.uniqueId(`${e}-grade-`),a={type:"GRADE",id:t,abbreviation:e,position:{x:0,y:0}};s.actions.addNode(a);const n={type:"HAS_GRADE",id:`garment -> ${t}`,sourceId:"garment",targetId:t,order:o};s.actions.addEdge(n)},reorderGrade(e,o){s.actions.updateEdge(`garment -> ${e}`,{order:o}),Object.values(s.state?.edges??{}).filter(t=>t.type==="HAS_GRADE"&&t.order>=o).sort((t,a)=>t.order-a.order).forEach(t=>s.actions.updateEdge(t.id,{order:t.order+1}))},removeGrade(e){if(!s.state?.edges||!s.state.adjacencyList)throw Error("edges not defined");const t=s.state.adjacencyList[e].inputs.at(0);if(!t)throw Error("edges not found");const{order:a}=s.state.edges[t];s.actions.removeNode(e),Object.values(s.state?.edges??{}).filter(n=>n.type==="HAS_GRADE"&&n.order>a).sort((n,d)=>n.order-d.order).forEach(n=>s.actions.updateEdge(n.id,{order:n.order-1}))},addPart(e,o,t){const a={type:"PART",id:e,label:e,position:{x:0,y:0},domId:o};let n;if(t){const d=`${t}->${e}`;n={inputs:{[d]:{id:d,sourceId:t,targetId:e,type:"COMPOSED_OF"}},outputs:{}}}s.actions.addNode(a,n)},removePart(e){s.actions.removeNode(e)},addMaterialUsage(e,o,t){t.forEach(C=>{Object.values(s.state?.nodes??{}).find(D=>D.id===C)||(console.log("adding type node"),s.actions.addNode({id:C,type:"MATERIAL_TYPE",label:w[C].label}))});const a=R.uniqueId("material-usage-"),n={type:"MATERIAL_USAGE",id:a,label:e,editableAttributes:["materialType","materialId"],materialId:"material-12",materialType:t[0]??"malha",position:{x:0,y:0},proxies:[]},d=`${a}-restriction-1`,I=`${o}->${a}`,A={inputs:{[I]:{id:I,sourceId:o,targetId:a,type:"MADE_OF"}},outputs:{}};s.actions.addNode(n,A);const G={type:"RESTRICTION",restrictionType:"allowOnly",attribute:"materialType",id:d,label:"Permitido apenas",operand:t,position:{x:0,y:0}},P=`${a}->${d}`,O={inputs:{[P]:{id:P,sourceId:a,targetId:d,attr:"materialType",type:"RESTRICTED_BY"}},outputs:{}};s.actions.addNode(G,O)},removeMaterialUsage(e){s.actions.removeNode(e)},addRestriction(e,o){i(j({compositionName:c.name,materialId:e,restriction:o}))},updateRestriction(e,o,t){i(V({compositionName:c.name,materialId:e,restrictionId:o,changes:t}))},removeRestriction(e,o){i(L({compositionName:c.name,materialId:e,restrictionId:o}))},removeOperation(e){s.actions.removeNode(e)},addOperation(e,o,t,a){const n=R.uniqueId("operation-"),d=`${a}->${n}`,I={id:n,type:"OPERATION",label:e,position:{x:0,y:0},cost:o,time_taken:t},A={inputs:{[d]:{id:d,sourceId:a,targetId:n,type:"PROCESS_NEEDED"}},outputs:{}};s.actions.addNode(I,A)},updateMaterialConsuption:(e,o)=>{s.actions.updateEdge(e,o)},deleteMaterialConsuption:e=>{s.actions.removeEdge(e)},addMaterialConsuption:(e,o,t)=>{const a={id:`${e}->${o}`,sourceId:e,targetId:o,type:"CONSUMES",quantity:t};s.actions.addEdge(a)},selectPart(e){i(_({compositionName:c.name,partName:e})),b.functions.openDetails()},changeMaterialType(e,o){s.actions.nodeExists(o)||i(k({compositionName:c?.name,materialType:o})),s.actions.updateNode({id:e,materialType:o})},changeMaterial(e,o){i(U({compositionName:c?.name,materialUsageId:e,materialId:o}))},addProxy(e,o){i(q({compositionName:c.name,materialId:o,proxy:e}))},deleteProxy(e,o){i(B({compositionName:c.name,materialId:o,proxyId:e}))},updateProxy(){}}}},J=()=>{const f=p("Store"),M=p("Graph"),h=p("Layout"),E=p("SVG"),{useAppDispatch:y,useAppSelector:v}=f.hooks,N=y(),u=h.hooks.useViewportManager(),i=E.hooks.useSVGManager(),b=M.managers.graphs(),{compositionsManager:S}=v(H);return{functions:{listCompositions(){N(F())},createComposition(l,g){const r=u.functions.addViewport(l,"Composer",void 0,"composition-"),m=g;b.functions.createGraph(r),N(Y({name:r,viewportName:r,svgPath:m,graphId:r})),i.functions.loadSVG(m,r)},createDebugView(l,g){const r=`debug-${l}`;u.functions.createGroup(r,"blue"),u.functions.addToGroup(g,r);const m=u.functions.addViewport("Modelo","DebuggerViewport",r,"debug-");N(z({compositionName:l,debugViewport:m})),u.functions.selectViewport(m)},findComposition(l){return Object.values(S.compositions).find(l)}}}},Z=()=>{const f=p("Store"),{useAppSelector:M}=f.hooks,h=J(),E=M(y=>y.Composer.compositionsManager.compositionsList);return $.useLayoutEffect(()=>{h.functions.listCompositions()},[]),E};export{J as a,Z as b,X as u};
